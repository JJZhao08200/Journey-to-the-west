<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Data Analytics Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <!-- 引入 PapaParse 用于解析 CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* CSV 表格样式 */
    #csvTable {
      display: none;
      border-collapse: collapse;
      width: 80%;
      margin: 20px auto;
    }
    #csvTable th, #csvTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    #toggleCsvBtn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <header>
    <h1>📊 YouTube Data Analytics Dashboard</h1>
    <nav>
      <a href="index.html">🏠 DASHBOARD</a>
      <a href="team.html">👥 TEAM</a>
    </nav>
  </header>

  <main>
    <!-- Looker Studio 报告 -->
    <iframe width="50%" height="900" src="https://lookerstudio.google.com/embed/reporting/7b5b480f-a0e3-45f5-94e7-1dec99d1e329/page/JgD" frameborder="0" style="border:0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>

    <!-- ChatGPT API 交互 -->
    <div class="chat-container">
      <h2>🤖 Chat with GPT</h2>
      <textarea id="user-input" placeholder="Type your question..."></textarea>
      <button onclick="sendMessage()">Sending</button>
      <div id="chat-output"></div>
    </div>

    <!-- YouTube 数据获取 -->
    <div class="fetch-data-container">
      <h2>📊 Generate a Summary of Popular Videos at this Moment</h2>
      <button onclick="fetchYoutubeData()">Generate Data</button>
      <pre id="data-output"></pre>
    </div>

    <!-- CSV 表格区域（初始隐藏） -->
    <div class="csv-container">
      <h2>📑 CSV Display</h2>
      <button id="toggleCsvBtn">Display CSV File</button>
      <table id="csvTable">
        <!-- 表头和内容将在 JavaScript 中生成 -->
      </table>
    </div>
  </main>

  <footer>
    <p>📅 Generate Every Hour Automatically | Maintain by Team 9</p>
  </footer>

  <!-- ChatGPT API 交互脚本 -->
  <script>
    const API_KEY = "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";  // 替换为你的 OpenAI API Key

    async function sendMessage() {
      const userInput = document.getElementById("user-input").value;
      if (!userInput) return;

      document.getElementById("chat-output").innerHTML = "⏳ Generating...";
      
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
              model: "gpt-4",
              messages: [{ role: "user", content: userInput }]
          })
      });

      const data = await response.json();
      document.getElementById("chat-output").innerHTML = `<strong>ChatGPT:</strong> ${data.choices[0].message.content}`;
    }
  </script>

  <!-- YouTube 数据获取脚本 -->
  <script>
    async function fetchYoutubeData() {
      const API_URL = "https://9be3-34-55-7-219.ngrok-free.app/fetch_youtube_data";  // 替换为你的 ngrok URL
      try {
        document.getElementById("data-output").textContent = "⏳ 正在获取数据...";
        
        let response = await fetch(API_URL);
        let data = await response.json();

        console.log("✅ Data Generate Success:", data);
        document.getElementById("data-output").textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error("❌ Data Generate Failed:", error);
        document.getElementById("data-output").textContent = "❌ Data Generate Failed, Check API";
      }
    }
  </script>

  <!-- CSV 表格加载和显示脚本 -->
  <script>
    // 当页面加载时，通过 PapaParse 加载 CSV 文件
    document.addEventListener("DOMContentLoaded", function() {
      // 使用 fetch 加载 CSV 文件，确保 data.csv 在同一目录下
      fetch("data.csv")
        .then(response => response.text())
        .then(csvText => {
          const parsed = Papa.parse(csvText, { header: true });
          const table = document.getElementById("csvTable");

          // 生成表头
          if (parsed.meta.fields) {
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            parsed.meta.fields.forEach(field => {
              const th = document.createElement("th");
              th.textContent = field;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
          }

          // 生成表体
          const tbody = document.createElement("tbody");
          parsed.data.forEach(row => {
            const tr = document.createElement("tr");
            parsed.meta.fields.forEach(field => {
              const td = document.createElement("td");
              td.textContent = row[field] || "";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
        })
        .catch(error => {
          console.error("CSV 加载失败：", error);
        });
    });

    // 控制 CSV 表格显示/隐藏的按钮
    const toggleCsvBtn = document.getElementById("toggleCsvBtn");
    const csvTable = document.getElementById("csvTable");

    toggleCsvBtn.addEventListener("click", function() {
      if (csvTable.style.display === "none" || csvTable.style.display === "") {
        csvTable.style.display = "table";
        toggleCsvBtn.textContent = "Display CSV File of Hot 50";
      } else {
        csvTable.style.display = "none";
        toggleCsvBtn.textContent = "Display CSV File of Hot 50";
      }
    });
  </script>

  <script>
  window.location.href = "login.html"; // 访问 index.html 直接跳转到登录页
</script>

</body>
</html>
